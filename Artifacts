{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "newVMName": {
        "type": "string"
      },
      "vmHostName": {
        "type": "string"
      },
      "labName": {
        "type": "string",
        "defaultValue": "sf-devops-agents"
      },
      "size": {
        "type": "string",
        "defaultValue": "Standard_DS2_v2"
      },
      "userName": {
        "type": "string",
        "defaultValue": "sf-upg-agent"
      },
      "password": {
        "type": "securestring"
      },
      "Install_PowerShell_Module_moduleName": {
        "type": "string",
        "defaultValue": "Az"
      },
      "Azure_Pipelines_Agent_vstsAccount": {
        "type": "string"
      },
      "Azure_Pipelines_Agent_vstsPassword": {
        "type": "securestring"
      },
      "Azure_Pipelines_Agent_agentName": {
        "type": "string",
        "defaultValue": ""
      },
      "Azure_Pipelines_Agent_agentNameSuffix": {
        "type": "string",
        "defaultValue": ""
      },
      "Azure_Pipelines_Agent_poolName": {
        "type": "string"
      },
      "Azure_Pipelines_Agent_RunAsAutoLogon": {
        "type": "bool",
        "defaultValue": true
      },
      "Azure_Pipelines_Agent_windowsLogonAccount": {
        "type": "string",
        "defaultValue": "sf-upg-agent"
      },
      "Azure_Pipelines_Agent_windowsLogonPassword": {
        "type": "securestring"
      },
      "Azure_Pipelines_Agent_driveLetter": {
        "type": "string",
        "defaultValue": "C"
      },
      "Azure_Pipelines_Agent_workDirectory": {
        "type": "string",
        "defaultValue": "C:\\w"
      },
      "Azure_Pipelines_Agent_replaceAgent": {
        "type": "bool",
        "defaultValue": true
      },
      "Install_Chocolatey_Packages_packages": {
        "type": "string",
        "defaultValue": "netfx-4.8-devpack"
      },
      "Install_Chocolatey_Packages_allowEmptyChecksums": {
        "type": "bool",
        "defaultValue": true
      },
      "Install_Chocolatey_Packages_ignoreChecksums": {
        "type": "bool",
        "defaultValue": false
      },
      "Run_PowerShell_scriptFileUris": {
        "type": "string",
        "defaultValue": "[[\"https://sitefinitycloud.blob.core.windows.net/scripts/ConfigureDevTestLabVM.ps1\"]"
      },
      "Run_PowerShell_scriptToRun": {
        "type": "string",
        "defaultValue": "ConfigureDevTestLabVM.ps1"
      },
      "Run_PowerShell_scriptArguments": {
        "type": "string",
        "defaultValue": ""
      }
    },
    "variables": {
      "labSubnetName": "sf-devops-agentsSubnet",
      "labVirtualNetworkId": "[resourceId('Microsoft.DevTestLab/labs/virtualnetworks', parameters('labName'), variables('labVirtualNetworkName'))]",
      "labVirtualNetworkName": "sf-devops-agents",
      "vmId": "[resourceId ('Microsoft.DevTestLab/labs/virtualmachines', parameters('labName'), parameters('newVMName'))]",
      "vmName": "[concat(parameters('labName'), '/', parameters('newVMName'))]"
    },
    "resources": [
      {
        "apiVersion": "2018-10-15-preview",
        "type": "Microsoft.DevTestLab/labs/virtualmachines",
        "name": "[variables('vmName')]",
        "location": "[resourceGroup().location]",
        "properties": {
          "labVirtualNetworkId": "[variables('labVirtualNetworkId')]",
          "notes": "Visual Studio 2019 Community (latest release) on Windows Server 2019 (x64)",
          "galleryImageReference": {
            "offer": "visualstudio2019latest",
            "publisher": "microsoftvisualstudio",
            "sku": "vs-2019-comm-latest-ws2019",
            "osType": "Windows",
            "version": "latest"
          },
          "size": "[parameters('size')]",
          "userName": "[parameters('userName')]",
          "password": "[parameters('password')]",
          "isAuthenticationWithSshKey": false,
          "artifacts": [
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-noop')]"
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-node')]"
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-git')]"
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-azurepowershell')]"
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-install-powershell-module')]",
              "parameters": [
                {
                  "name": "moduleName",
                  "value": "[parameters('Install_PowerShell_Module_moduleName')]"
                }
              ]
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-chocolatey')]",
              "parameters": [
                {
                  "name": "packages",
                  "value": "[parameters('Install_Chocolatey_Packages_packages')]"
                },
                {
                  "name": "allowEmptyChecksums",
                  "value": "[parameters('Install_Chocolatey_Packages_allowEmptyChecksums')]"
                },
                {
                  "name": "ignoreChecksums",
                  "value": "[parameters('Install_Chocolatey_Packages_ignoreChecksums')]"
                }
              ]
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-winrm')]",
              "parameters": [
                {
                  "name": "hostName",
                  "value": "[parameters('vmHostName')]"
                }
              ]
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-vsts-build-agent')]",
              "parameters": [
                {
                  "name": "vstsAccount",
                  "value": "[parameters('Azure_Pipelines_Agent_vstsAccount')]"
                },
                {
                  "name": "vstsPassword",
                  "value": "[parameters('Azure_Pipelines_Agent_vstsPassword')]"
                },
                {
                  "name": "agentName",
                  "value": "[parameters('Azure_Pipelines_Agent_agentName')]"
                },
                {
                  "name": "agentNameSuffix",
                  "value": "[parameters('Azure_Pipelines_Agent_agentNameSuffix')]"
                },
                {
                  "name": "poolName",
                  "value": "[parameters('Azure_Pipelines_Agent_poolName')]"
                },
                {
                  "name": "RunAsAutoLogon",
                  "value": "[parameters('Azure_Pipelines_Agent_RunAsAutoLogon')]"
                },
                {
                  "name": "windowsLogonAccount",
                  "value": "[parameters('Azure_Pipelines_Agent_windowsLogonAccount')]"
                },
                {
                  "name": "windowsLogonPassword",
                  "value": "[parameters('Azure_Pipelines_Agent_windowsLogonPassword')]"
                },
                {
                  "name": "driveLetter",
                  "value": "[parameters('Azure_Pipelines_Agent_driveLetter')]"
                },
                {
                  "name": "workDirectory",
                  "value": "[parameters('Azure_Pipelines_Agent_workDirectory')]"
                },
                {
                  "name": "replaceAgent",
                  "value": "[parameters('Azure_Pipelines_Agent_replaceAgent')]"
                }
              ]
            },
            {
              "artifactId": "[resourceId('Microsoft.DevTestLab/labs/artifactSources/artifacts', parameters('labName'), 'public repo', 'windows-run-powershell')]",
              "parameters": [
                {
                  "name": "scriptFileUris",
                  "value": "[parameters('Run_PowerShell_scriptFileUris')]"
                },
                {
                  "name": "scriptToRun",
                  "value": "[parameters('Run_PowerShell_scriptToRun')]"
                },
                {
                  "name": "scriptArguments",
                  "value": "[parameters('Run_PowerShell_scriptArguments')]"
                }
              ]
            }
          ],
          "labSubnetName": "[variables('labSubnetName')]",
          "disallowPublicIpAddress": false,
          "storageType": "StandardSSD",
          "allowClaim": false
        }
      },
      {
        "type": "Microsoft.Compute/virtualMachines/extensions",
        "apiVersion": "2015-06-15",
        "name": "[concat(parameters('newVMName'), '/IaaSAntimalware')]",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "[resourceId ('Microsoft.DevTestLab/labs/virtualmachines', parameters('labName'), parameters('newVMName'))]"
        ],
        "properties": {
            "autoUpgradeMinorVersion": true,
            "publisher": "Microsoft.Azure.Security",
            "type": "IaaSAntimalware",
            "typeHandlerVersion": "1.3",
            "settings": {
                "AntimalwareEnabled": true,
                "RealtimeProtectionEnabled": "true",
                "ScheduledScanSettings": {
                    "isEnabled": "false",
                    "day": "7",
                    "time": "120",
                    "scanType": "Quick"
                },
                "Exclusions": {
                    "Paths": "",
                    "Extensions": "",
                    "Processes": ""
                }
            }
        }
      }
    ]
  }
